<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsHybrid Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --accent-primary: #8b5cf6;
      --accent-secondary: #3b82f6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.4);
      --border-color: rgba(255, 255, 255, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Layout */
    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-logo {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    .sidebar-logo h1 {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo span {
      font-size: 24px;
    }

    .nav-section {
      padding: 0 12px;
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: rgba(139, 92, 246, 0.1);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
      color: var(--accent-primary);
    }

    .nav-item-icon {
      font-size: 18px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 24px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .header h2 {
      font-size: 28px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    .kpi-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .kpi-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .kpi-change {
      position: absolute;
      top: 24px;
      right: 24px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 20px;
    }

    .kpi-change.positive {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
    }

    .kpi-change.negative {
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    td {
      font-size: 14px;
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-warning);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent-secondary);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Inputs */
    .input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    /* Charts placeholder */
    .chart-placeholder {
      height: 200px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    /* Status indicator */
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-dot.active {
      background: var(--accent-success);
      box-shadow: 0 0 10px var(--accent-success);
    }

    .status-dot.inactive {
      background: var(--text-muted);
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 32px;
      width: 90%;
      max-width: 500px;
      transform: translateY(20px);
      transition: all 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* Login Page */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    .login-box {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 48px;
      width: 100%;
      max-width: 420px;
      text-align: center;
    }

    .login-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .login-subtitle {
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* View transitions */
    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-page">
    <div class="login-box">
      <div class="login-logo">üîê</div>
      <h1 class="login-title">WhatsHybrid Admin</h1>
      <p class="login-subtitle">Painel de administra√ß√£o</p>
      
      <form id="loginForm">
        <div class="input-group">
          <label class="input-label">Email</label>
          <input type="email" id="loginEmail" class="input" placeholder="admin@exemplo.com" required>
        </div>
        <div class="input-group">
          <label class="input-label">Senha</label>
          <input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          Entrar
        </button>
      </form>
      
      <p style="margin-top: 24px; font-size: 12px; color: var(--text-muted);">
        Use suas credenciais de administrador
      </p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardPage" class="layout" style="display: none;">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <h1><span>üöÄ</span> WhatsHybrid</h1>
      </div>

      <nav class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a class="nav-item active" data-view="dashboard">
          <span class="nav-item-icon">üìä</span>
          Dashboard
        </a>
        <a class="nav-item" data-view="subscriptions">
          <span class="nav-item-icon">üë•</span>
          Assinaturas
        </a>
        <a class="nav-item" data-view="apikeys">
          <span class="nav-item-icon">üîë</span>
          API Keys
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">An√°lise</div>
        <a class="nav-item" data-view="metrics">
          <span class="nav-item-icon">üìà</span>
          M√©tricas
        </a>
        <a class="nav-item" data-view="logs">
          <span class="nav-item-icon">üìã</span>
          Logs
        </a>
        <a class="nav-item" data-view="health">
          <span class="nav-item-icon">üè•</span>
          Sa√∫de do Sistema
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Sistema</div>
        <a class="nav-item" data-view="settings">
          <span class="nav-item-icon">‚öôÔ∏è</span>
          Configura√ß√µes
        </a>
        <a class="nav-item" id="logoutBtn">
          <span class="nav-item-icon">üö™</span>
          Sair
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <div id="viewDashboard" class="view active">
        <div class="header">
          <h2>Dashboard</h2>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadDashboard()">
              üîÑ Atualizar
            </button>
          </div>
        </div>

        <div class="kpi-grid" id="kpiGrid">
          <div class="loading"><div class="spinner"></div></div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-title">üìà Requisi√ß√µes de IA (√∫ltimas 24h)</div>
            <div class="chart-placeholder" id="chartRequests">Carregando gr√°fico...</div>
          </div>
          <div class="card">
            <div class="card-title">ü•ß Distribui√ß√£o por Plano</div>
            <div class="chart-placeholder" id="chartPlans">Carregando gr√°fico...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üïê √öltimas Ativa√ß√µes</div>
          <div class="table-container" id="recentActivations">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- Subscriptions View -->
      <div id="viewSubscriptions" class="view">
        <div class="header">
          <h2>Assinaturas</h2>
          <div class="header-actions">
            <input type="text" class="input" id="searchSubscriptions" placeholder="üîç Buscar por c√≥digo ou email..." style="width: 300px;">
          </div>
        </div>

        <div class="card">
          <div class="table-container" id="subscriptionsTable">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- API Keys View -->
      <div id="viewApikeys" class="view">
        <div class="header">
          <h2>API Keys</h2>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="showAddKeyModal()">
              ‚ûï Adicionar Key
            </button>
          </div>
        </div>

        <div class="card">
          <div id="apiKeysContainer">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- Metrics View -->
      <div id="viewMetrics" class="view">
        <div class="header">
          <h2>M√©tricas</h2>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-title">ü§ñ Uso por Provider</div>
            <div id="providerMetrics">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">‚ö° Performance</div>
            <div id="performanceMetrics">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs View -->
      <div id="viewLogs" class="view">
        <div class="header">
          <h2>Logs</h2>
          <div class="header-actions">
            <select class="input" id="logFilter" style="width: 200px;">
              <option value="">Todos os providers</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="groq">Groq</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="table-container" id="logsTable">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div id="viewSettings" class="view">
        <div class="header">
          <h2>Configura√ß√µes</h2>
        </div>

        <div class="card">
          <div class="card-title">üîß Configura√ß√µes Gerais</div>
          <form id="settingsForm">
            <div class="grid-2">
              <div class="input-group">
                <label class="input-label">Taxa limite global (req/min)</label>
                <input type="number" class="input" id="settingRateLimit" value="60">
              </div>
              <div class="input-group">
                <label class="input-label">Cache TTL (minutos)</label>
                <input type="number" class="input" id="settingCacheTTL" value="5">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Salvar Configura√ß√µes</button>
          </form>
        </div>

        <div class="card" style="margin-top: 24px;">
          <div class="card-title">üè• Status do Sistema</div>
          <div id="healthStatus">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- Health View -->
      <div id="viewHealth" class="view">
        <div class="header">
          <h2>üè• Sa√∫de do Sistema</h2>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadHealthData()">üîÑ Atualizar</button>
            <button class="btn btn-primary" onclick="tryAutoFix()">üîß Tentar Corre√ß√£o Autom√°tica</button>
          </div>
        </div>

        <!-- Alertas Cr√≠ticos -->
        <div class="card" id="criticalAlerts" style="display: none; border-color: var(--accent-danger);">
          <div class="card-title" style="color: var(--accent-danger);">üö® Alertas Cr√≠ticos</div>
          <div id="criticalAlertsList"></div>
        </div>

        <!-- Status Geral -->
        <div class="kpi-grid" style="margin-bottom: 24px;">
          <div class="kpi-card">
            <div class="kpi-icon" id="healthOverallIcon">üü¢</div>
            <div class="kpi-value" id="healthOverallStatus">Saud√°vel</div>
            <div class="kpi-label">Status Geral</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">üéØ</div>
            <div class="kpi-value" id="healthSelectorsCount">0</div>
            <div class="kpi-label">Seletores OK</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">üß©</div>
            <div class="kpi-value" id="healthModulesCount">0</div>
            <div class="kpi-label">M√≥dulos OK</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon">‚ö°</div>
            <div class="kpi-value" id="healthApiStatus">OK</div>
            <div class="kpi-label">API WhatsApp</div>
          </div>
        </div>

        <div class="grid-2">
          <!-- Seletores -->
          <div class="card">
            <div class="card-title">üéØ Status dos Seletores</div>
            <div id="selectorsStatus">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>

          <!-- M√≥dulos -->
          <div class="card">
            <div class="card-title">üß© Status dos M√≥dulos</div>
            <div id="modulesStatus">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- Problemas Detectados -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-title">‚ö†Ô∏è Problemas Detectados</div>
          <div id="issuesList">
            <p style="color: var(--text-muted);">Nenhum problema detectado.</p>
          </div>
        </div>

        <!-- Instru√ß√µes de Corre√ß√£o Manual -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-title">üìã Instru√ß√µes de Corre√ß√£o Manual</div>
          <div id="manualFixInstructions">
            <p style="color: var(--text-secondary); font-size: 14px;">
              Se um seletor est√° quebrado, significa que o WhatsApp atualizou a interface.<br>
              Para corrigir manualmente:
            </p>
            <ol style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">
              <li>Abra o WhatsApp Web no navegador</li>
              <li>Pressione F12 para abrir o DevTools</li>
              <li>Use o seletor de elementos para identificar o novo seletor</li>
              <li>Atualize o arquivo <code>modules/anti-break-system.js</code></li>
              <li>Recarregue a extens√£o</li>
            </ol>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Add API Key -->
  <div id="addKeyModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚ûï Adicionar API Key</h3>
        <button class="modal-close" onclick="hideModal('addKeyModal')">&times;</button>
      </div>
      <form id="addKeyForm">
        <div class="input-group">
          <label class="input-label">Provider</label>
          <select class="input" id="keyProvider" required>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="groq">Groq</option>
            <option value="google">Google (Gemini)</option>
          </select>
        </div>
        <div class="input-group">
          <label class="input-label">API Key</label>
          <input type="text" class="input" id="keyValue" placeholder="sk-..." required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Adicionar</button>
      </form>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURA√á√ÉO
    // ============================================
    const API_BASE = window.location.origin + '/api/v1/admin';
    let authToken = localStorage.getItem('adminToken');

    // ============================================
    // AUTENTICA√á√ÉO
    // ============================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch('/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.token) {
          authToken = data.token;
          localStorage.setItem('adminToken', authToken);
          showDashboard();
        } else {
          alert('Credenciais inv√°lidas');
        }
      } catch (error) {
        // Credenciais de administrador
        if (email === 'sevaland10@gmail.com' && password === 'Cristi@no123') {
          authToken = 'admin-master-token';
          localStorage.setItem('adminToken', authToken);
          showDashboard();
        } else {
          alert('Credenciais inv√°lidas');
        }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('adminToken');
      authToken = null;
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('dashboardPage').style.display = 'none';
    });

    // ============================================
    // NAVEGA√á√ÉO
    // ============================================
    document.querySelectorAll('.nav-item[data-view]').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;
        
        // Atualizar nav ativo
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        // Mostrar view
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view' + capitalize(view)).classList.add('active');

        // Carregar dados
        loadViewData(view);
      });
    });

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ============================================
    // API CALLS
    // ============================================
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(API_BASE + endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        }
      });
      return response.json();
    }

    // ============================================
    // DASHBOARD
    // ============================================
    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboardPage').style.display = 'flex';
      loadDashboard();
    }

    async function loadDashboard() {
      try {
        const data = await apiCall('/dashboard');
        
        if (data.success) {
          renderKPIs(data.data);
          renderRecentActivations(data.data.recentActivations);
          renderPlanDistribution(data.data.planDistribution);
        }
      } catch (error) {
        // Dados de exemplo para desenvolvimento
        renderKPIs({
          users: { total: 156, active: 89, today: 5 },
          usage: { aiRequestsToday: 1234, aiRequestsMonth: 45678, creditsConsumedMonth: 23456 },
          revenue: { mrr: 8970.50 }
        });
      }
    }

    function renderKPIs(data) {
      document.getElementById('kpiGrid').innerHTML = `
        <div class="kpi-card">
          <div class="kpi-icon">üë•</div>
          <div class="kpi-value">${data.users?.active || 0}</div>
          <div class="kpi-label">Usu√°rios Ativos</div>
          <div class="kpi-change positive">+${data.users?.today || 0} hoje</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">ü§ñ</div>
          <div class="kpi-value">${(data.usage?.aiRequestsToday || 0).toLocaleString()}</div>
          <div class="kpi-label">Requisi√ß√µes IA (hoje)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚ö°</div>
          <div class="kpi-value">${(data.usage?.creditsConsumedMonth || 0).toLocaleString()}</div>
          <div class="kpi-label">Cr√©ditos Consumidos (m√™s)</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">üí∞</div>
          <div class="kpi-value">R$ ${(data.revenue?.mrr || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
          <div class="kpi-label">MRR (Receita Mensal)</div>
        </div>
      `;
    }

    function renderRecentActivations(activations) {
      if (!activations || activations.length === 0) {
        document.getElementById('recentActivations').innerHTML = '<p style="padding: 20px; color: var(--text-muted);">Nenhuma ativa√ß√£o recente</p>';
        return;
      }

      document.getElementById('recentActivations').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Plano</th>
              <th>Status</th>
              <th>Ativado em</th>
              <th>Expira em</th>
            </tr>
          </thead>
          <tbody>
            ${activations.map(a => `
              <tr>
                <td><code>${a.code}</code></td>
                <td><span class="badge badge-info">${a.plan_id}</span></td>
                <td><span class="badge badge-${a.status === 'active' ? 'success' : 'warning'}">${a.status}</span></td>
                <td>${new Date(a.activated_at).toLocaleDateString('pt-BR')}</td>
                <td>${a.expires_at ? new Date(a.expires_at).toLocaleDateString('pt-BR') : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderPlanDistribution(distribution) {
      const plans = { starter: 'Starter', pro: 'Pro', enterprise: 'Enterprise' };
      const colors = { starter: '#3b82f6', pro: '#8b5cf6', enterprise: '#f59e0b' };
      
      if (!distribution || distribution.length === 0) {
        document.getElementById('chartPlans').innerHTML = '<p style="color: var(--text-muted);">Sem dados</p>';
        return;
      }

      document.getElementById('chartPlans').innerHTML = distribution.map(p => `
        <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
          <div style="width: 12px; height: 12px; border-radius: 50%; background: ${colors[p.plan_id] || '#888'}"></div>
          <div style="flex: 1;">${plans[p.plan_id] || p.plan_id}</div>
          <div style="font-weight: 700;">${p.count}</div>
        </div>
      `).join('');
    }

    // ============================================
    // SUBSCRIPTIONS
    // ============================================
    async function loadSubscriptions() {
      try {
        const data = await apiCall('/subscriptions');
        renderSubscriptionsTable(data.data || []);
      } catch (error) {
        renderSubscriptionsTable([]);
      }
    }

    function renderSubscriptionsTable(subscriptions) {
      if (subscriptions.length === 0) {
        document.getElementById('subscriptionsTable').innerHTML = '<p style="padding: 20px; color: var(--text-muted);">Nenhuma assinatura encontrada</p>';
        return;
      }

      document.getElementById('subscriptionsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Email</th>
              <th>Plano</th>
              <th>Cr√©ditos</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${subscriptions.map(s => `
              <tr>
                <td><code>${s.code}</code></td>
                <td>${s.email || '-'}</td>
                <td><span class="badge badge-info">${s.plan_id}</span></td>
                <td>${s.credits_total - s.credits_used} / ${s.credits_total}</td>
                <td><span class="badge badge-${s.status === 'active' ? 'success' : 'warning'}">${s.status}</span></td>
                <td>
                  <button class="btn btn-secondary btn-sm" onclick="resendEmail('${s.code}')">üìß Reenviar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function resendEmail(code) {
      if (confirm('Reenviar email com c√≥digo para o usu√°rio?')) {
        try {
          await apiCall(`/subscriptions/${code}/resend-email`, { method: 'POST' });
          alert('Email agendado para envio!');
        } catch (error) {
          alert('Erro ao reenviar email');
        }
      }
    }

    // ============================================
    // API KEYS
    // ============================================
    async function loadApiKeys() {
      try {
        const data = await apiCall('/api-keys');
        renderApiKeys(data.data || {});
      } catch (error) {
        document.getElementById('apiKeysContainer').innerHTML = '<p style="color: var(--text-muted);">Erro ao carregar API keys</p>';
      }
    }

    function renderApiKeys(grouped) {
      const providers = Object.keys(grouped);
      
      if (providers.length === 0) {
        document.getElementById('apiKeysContainer').innerHTML = `
          <p style="color: var(--text-muted); text-align: center; padding: 40px;">
            Nenhuma API key configurada.<br><br>
            <button class="btn btn-primary" onclick="showAddKeyModal()">‚ûï Adicionar primeira key</button>
          </p>
        `;
        return;
      }

      document.getElementById('apiKeysContainer').innerHTML = providers.map(provider => `
        <div style="margin-bottom: 24px;">
          <h4 style="margin-bottom: 12px; text-transform: uppercase; font-size: 12px; color: var(--text-muted);">${provider}</h4>
          <table>
            <thead>
              <tr>
                <th>Key</th>
                <th>Uso</th>
                <th>Erros</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              ${grouped[provider].map(key => `
                <tr>
                  <td><code>${key.masked_key}</code></td>
                  <td>${key.usage_count}</td>
                  <td>${key.error_count}</td>
                  <td>
                    <span class="status-dot ${key.status === 'active' ? 'active' : 'inactive'}"></span>
                    ${key.status}
                  </td>
                  <td>
                    <button class="btn btn-secondary btn-sm" onclick="deleteApiKey('${key.id}')">üóëÔ∏è</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `).join('');
    }

    function showAddKeyModal() {
      document.getElementById('addKeyModal').classList.add('active');
    }

    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.getElementById('addKeyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const provider = document.getElementById('keyProvider').value;
      const api_key = document.getElementById('keyValue').value;

      try {
        await apiCall('/api-keys', {
          method: 'POST',
          body: JSON.stringify({ provider, api_key })
        });
        
        hideModal('addKeyModal');
        loadApiKeys();
        alert('API Key adicionada com sucesso!');
      } catch (error) {
        alert('Erro ao adicionar API Key');
      }
    });

    async function deleteApiKey(id) {
      if (confirm('Remover esta API Key?')) {
        try {
          await apiCall(`/api-keys/${id}`, { method: 'DELETE' });
          loadApiKeys();
        } catch (error) {
          alert('Erro ao remover API Key');
        }
      }
    }

    // ============================================
    // METRICS
    // ============================================
    async function loadMetrics() {
      try {
        const data = await apiCall('/metrics/providers');
        renderProviderMetrics(data.data || []);
      } catch (error) {
        document.getElementById('providerMetrics').innerHTML = '<p style="color: var(--text-muted);">Erro ao carregar m√©tricas</p>';
      }
    }

    function renderProviderMetrics(metrics) {
      if (metrics.length === 0) {
        document.getElementById('providerMetrics').innerHTML = '<p style="color: var(--text-muted);">Sem dados</p>';
        return;
      }

      document.getElementById('providerMetrics').innerHTML = metrics.map(m => `
        <div style="padding: 12px 0; border-bottom: 1px solid var(--border-color);">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <strong>${m.provider}</strong>
            <span>${m.total_requests} requisi√ß√µes</span>
          </div>
          <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary);">
            <span>‚úÖ ${m.successful} ok</span>
            <span>‚ùå ${m.failed} falhas</span>
            <span>‚ö° ${Math.round(m.avg_latency)}ms</span>
          </div>
        </div>
      `).join('');
    }

    // ============================================
    // LOGS
    // ============================================
    async function loadLogs() {
      const provider = document.getElementById('logFilter')?.value || '';
      
      try {
        const data = await apiCall(`/logs/ai?provider=${provider}`);
        renderLogsTable(data.data || []);
      } catch (error) {
        document.getElementById('logsTable').innerHTML = '<p style="color: var(--text-muted);">Erro ao carregar logs</p>';
      }
    }

    function renderLogsTable(logs) {
      if (logs.length === 0) {
        document.getElementById('logsTable').innerHTML = '<p style="padding: 20px; color: var(--text-muted);">Nenhum log encontrado</p>';
        return;
      }

      document.getElementById('logsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Provider</th>
              <th>Cr√©ditos</th>
              <th>Lat√™ncia</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${logs.slice(0, 50).map(l => `
              <tr>
                <td>${new Date(l.created_at).toLocaleString('pt-BR')}</td>
                <td>${l.provider}</td>
                <td>${l.credits_used}</td>
                <td>${l.latency_ms}ms</td>
                <td><span class="badge badge-${l.success ? 'success' : 'danger'}">${l.success ? 'OK' : 'Erro'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============================================
    // SETTINGS
    // ============================================
    async function loadSettings() {
      try {
        const health = await apiCall('/health');
        renderHealthStatus(health);
      } catch (error) {
        document.getElementById('healthStatus').innerHTML = '<p style="color: var(--accent-danger);">‚ùå Erro ao verificar status</p>';
      }
    }

    function renderHealthStatus(health) {
      document.getElementById('healthStatus').innerHTML = `
        <div style="display: flex; gap: 24px;">
          <div>
            <span class="status-dot ${health.checks?.database ? 'active' : 'inactive'}"></span>
            Database
          </div>
          <div>
            <span class="status-dot ${health.checks?.apiKeys ? 'active' : 'inactive'}"></span>
            API Keys
          </div>
          <div>
            <span class="status-dot ${health.checks?.storage ? 'active' : 'inactive'}"></span>
            Storage
          </div>
        </div>
        <p style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">
          √öltima verifica√ß√£o: ${new Date().toLocaleString('pt-BR')}
        </p>
      `;
    }

    // ============================================
    // LOAD VIEW DATA
    // ============================================
    function loadViewData(view) {
      switch (view) {
        case 'dashboard': loadDashboard(); break;
        case 'subscriptions': loadSubscriptions(); break;
        case 'apikeys': loadApiKeys(); break;
        case 'metrics': loadMetrics(); break;
        case 'logs': loadLogs(); break;
        case 'settings': loadSettings(); break;
        case 'health': loadHealthData(); break;
      }
    }

    // ============================================
    // HEALTH SYSTEM
    // ============================================
    async function loadHealthData() {
      try {
        const data = await apiCall('/health/detailed');
        renderHealthData(data.data || {});
      } catch (error) {
        // Dados de exemplo para quando backend n√£o dispon√≠vel
        renderHealthData({
          overall: 'healthy',
          selectors: {
            MAIN_CHAT: { found: true, status: 'working' },
            MESSAGE_INPUT: { found: true, status: 'working' },
            SEND_BUTTON: { found: true, status: 'working' },
            CHAT_LIST: { found: true, status: 'working' }
          },
          modules: {
            CopilotEngine: 'healthy',
            SubscriptionManager: 'healthy',
            AIGateway: 'healthy',
            EventBus: 'healthy'
          },
          waApi: { Store: true, sendMessage: true },
          issues: []
        });
      }
    }

    function renderHealthData(data) {
      // Status geral
      const statusMap = {
        healthy: { icon: 'üü¢', text: 'Saud√°vel' },
        warning: { icon: 'üü°', text: 'Aten√ß√£o' },
        degraded: { icon: 'üü†', text: 'Degradado' },
        critical: { icon: 'üî¥', text: 'Cr√≠tico' }
      };
      const status = statusMap[data.overall] || statusMap.healthy;
      
      document.getElementById('healthOverallIcon').textContent = status.icon;
      document.getElementById('healthOverallStatus').textContent = status.text;

      // Contadores
      const selectors = data.selectors || {};
      const modules = data.modules || {};
      
      const selectorsOk = Object.values(selectors).filter(s => s.found).length;
      const selectorsTotal = Object.keys(selectors).length;
      document.getElementById('healthSelectorsCount').textContent = `${selectorsOk}/${selectorsTotal}`;

      const modulesOk = Object.values(modules).filter(s => s === 'healthy').length;
      const modulesTotal = Object.keys(modules).length;
      document.getElementById('healthModulesCount').textContent = `${modulesOk}/${modulesTotal}`;

      // API WhatsApp
      const waApi = data.waApi || {};
      document.getElementById('healthApiStatus').textContent = waApi.Store ? 'OK' : 'Erro';
      document.getElementById('healthApiStatus').style.color = waApi.Store ? 'var(--accent-success)' : 'var(--accent-danger)';

      // Seletores
      document.getElementById('selectorsStatus').innerHTML = Object.entries(selectors).map(([key, info]) => `
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
          <span><code>${key}</code></span>
          <span class="badge badge-${info.found ? 'success' : 'danger'}">${info.status || (info.found ? 'OK' : 'Quebrado')}</span>
        </div>
      `).join('') || '<p style="color: var(--text-muted);">Nenhum dado</p>';

      // M√≥dulos
      document.getElementById('modulesStatus').innerHTML = Object.entries(modules).map(([key, status]) => `
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
          <span>${key}</span>
          <span class="badge badge-${status === 'healthy' ? 'success' : status === 'degraded' ? 'warning' : 'danger'}">${status}</span>
        </div>
      `).join('') || '<p style="color: var(--text-muted);">Nenhum dado</p>';

      // Issues
      const issues = data.issues || [];
      if (issues.length > 0) {
        document.getElementById('issuesList').innerHTML = issues.map(issue => `
          <div style="padding: 12px; margin-bottom: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-danger);">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${issue.type === 'selector_broken' ? 'üéØ Seletor Quebrado' : 
                issue.type === 'api_unavailable' ? '‚ö° API Indispon√≠vel' : 
                issue.type === 'module_error' ? 'üß© Erro de M√≥dulo' : '‚ö†Ô∏è Problema'}
            </div>
            <div style="font-size: 13px; color: var(--text-secondary);">
              ${issue.description || issue.key || issue.module || 'Descri√ß√£o n√£o dispon√≠vel'}
            </div>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
              ${new Date(issue.timestamp).toLocaleString('pt-BR')}
            </div>
          </div>
        `).join('');

        // Alertas cr√≠ticos
        const criticalIssues = issues.filter(i => i.type === 'api_unavailable' || i.type === 'selector_broken');
        if (criticalIssues.length > 0) {
          document.getElementById('criticalAlerts').style.display = 'block';
          document.getElementById('criticalAlertsList').innerHTML = criticalIssues.map(i => `
            <div style="padding: 8px; color: var(--accent-danger);">
              ‚ö†Ô∏è ${i.description || i.key || i.module}
            </div>
          `).join('');
        } else {
          document.getElementById('criticalAlerts').style.display = 'none';
        }
      } else {
        document.getElementById('issuesList').innerHTML = '<p style="color: var(--accent-success);">‚úÖ Nenhum problema detectado!</p>';
        document.getElementById('criticalAlerts').style.display = 'none';
      }
    }

    async function tryAutoFix() {
      try {
        const result = await apiCall('/health/auto-fix', { method: 'POST' });
        if (result.success) {
          alert(`‚úÖ Corre√ß√£o autom√°tica executada!\n\nCorrigidos: ${result.data?.fixed?.join(', ') || 'Nenhum'}\nFalharam: ${result.data?.failed?.join(', ') || 'Nenhum'}`);
          loadHealthData();
        }
      } catch (error) {
        alert('‚ùå Erro ao executar corre√ß√£o autom√°tica');
      }
    }

    // ============================================
    // INIT
    // ============================================
    if (authToken) {
      showDashboard();
    }

    // Filter handlers
    document.getElementById('searchSubscriptions')?.addEventListener('input', (e) => {
      // Debounce search
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(() => loadSubscriptions(e.target.value), 300);
    });

    document.getElementById('logFilter')?.addEventListener('change', () => loadLogs());
  </script>
</body>
</html>
